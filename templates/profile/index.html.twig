{% extends 'base.html.twig' %}

{% block title %}Mon Profil{% endblock %}

{% block body %}
<div class="container mt-5">
    <div class="row">
        <!-- Colonne avatar -->
        <div class="col-md-3 text-center">
            <form id="avatarForm" action="{{ path('profile_upload_avatar') }}" method="POST" enctype="multipart/form-data">
                <input type="file" name="avatar" id="avatarInput" style="display:none;" accept="image/*" onchange="document.getElementById('avatarForm').submit();">
                {% if app.user.avatar %}
                    <img src="{{ asset('uploads/avatars/' ~ app.user.avatar) }}" class="rounded-circle img-thumbnail" style="width:150px; height:150px; object-fit:cover; cursor:pointer;" alt="{{ app.user.username }}" onclick="document.getElementById('avatarInput').click();">
                {% else %}
                    <img src="{{ asset('images/default-avatar.png') }}" class="rounded-circle img-thumbnail" style="width:150px; height:150px; object-fit:cover; cursor:pointer;" alt="Avatar par défaut" onclick="document.getElementById('avatarInput').click();">
                {% endif %}
            </form>
            <h3 class="mt-3">{{ app.user.username }}</h3>
        </div>

        <!-- Colonne infos utilisateur -->
        <div class="col-md-9">
            <div class="card p-3 mb-4">
                <form method="POST" action="{{ path('profile') }}">
                    <textarea name="presentation" class="form-control" rows="5" placeholder="Présentez-vous...">{{ user.presentation }}</textarea>
                    <div class="text-end mt-2">
                        <button type="submit" class="btn btn-primary">Enregistrer</button>
                    </div>
                </form>
            </div>

            {% set displayed_ids = [] %}

            <!-- Section recettes créées par l'utilisateur -->
            <h4>Mes recettes</h4>
            {% if recipes|length > 0 %}
                <div class="row">
                    {% for recipe in recipes %}
                        {% if recipe.id not in displayed_ids %}
                            {% set displayed_ids = displayed_ids|merge([recipe.id]) %}
                            <div class="col-md-4 mb-3">
                                <div class="card h-100 shadow-sm" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#recipeModal{{ recipe.id }}">
                                    {% if recipe.image %}
                                        <img src="{{ asset('uploads/recipes/' ~ recipe.image) }}" class="card-img-top" alt="{{ recipe.title }}">
                                    {% else %}
                                        <img src="https://via.placeholder.com/400x200?text=Recette" class="card-img-top" alt="{{ recipe.title }}">
                                    {% endif %}
                                    <div class="card-body d-flex flex-column">
                                        <h5 class="card-title">{{ recipe.title }}</h5>
                                        <p class="card-text">{{ recipe.description|slice(0, 80) ~ '...' }}</p>
                                        <div class="mt-auto d-flex justify-content-between">
                                            <div class="d-flex gap-1">
                                                <a href="{{ path('recipe_edit', {'id': recipe.id}) }}" class="btn btn-sm btn-outline-primary">Modifier</a>
                                                <button class="btn btn-sm btn-outline-danger delete-btn" 
                                                        data-recipe-id="{{ recipe.id }}" 
                                                        data-csrf="{{ csrf_token('delete' ~ recipe.id) }}">
                                                    Supprimer
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal description recette -->
                            <div class="modal fade" id="recipeModal{{ recipe.id }}" tabindex="-1" aria-labelledby="recipeModalLabel{{ recipe.id }}" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="recipeModalLabel{{ recipe.id }}">{{ recipe.title }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                        </div>
                                        <div class="modal-body">
                                            {% if recipe.user %}
                                                <div class="d-flex align-items-center mb-3">
                                                    {% if recipe.user.avatar %}
                                                        <img src="{{ asset('uploads/avatars/' ~ recipe.user.avatar) }}" alt="{{ recipe.user.username }}" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                                                    {% else %}
                                                        <img src="{{ asset('images/default-avatar.png') }}" alt="{{ recipe.user.username }}" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                                                    {% endif %}
                                                    <a href="{{ path('user_show', {'id': recipe.user.id}) }}" class="fw-bold text-decoration-none">{{ recipe.user.username }}</a>
                                                </div>
                                            {% endif %}
                                            {% if recipe.image %}
                                                <img src="{{ asset('uploads/recipes/' ~ recipe.image) }}" class="img-fluid mb-3" alt="{{ recipe.title }}">
                                            {% endif %}
                                            <p><strong>Description:</strong> {{ recipe.description }}</p>
                                            <p><strong>Ingrédients:</strong></p>
                                            <pre>{{ recipe.ingredients }}</pre>
                                            <p><strong>Étapes:</strong></p>
                                            <pre>{{ recipe.steps }}</pre>
                                            <p><strong>Catégorie:</strong> {{ recipe.category.name }}</p>
                                            <p><strong>Préparation:</strong> {{ recipe.preparationTime }} min</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Vous n'avez créé aucune recette pour le moment.</p>
            {% endif %}

            <!-- Section recettes favorites -->
            <h4 class="mt-4">Mes favoris</h4>
            {% if app.user.favorites|length > 0 %}
                <div class="row">
                    {% for fav in app.user.favorites %}
                        {% set r = fav.recipe %}
                        {% if r.id not in displayed_ids %}
                            {% set displayed_ids = displayed_ids|merge([r.id]) %}
                            <div class="col-md-3 mb-3">
                                <div class="card h-100 shadow-sm" style="cursor:pointer;" data-bs-toggle="modal" data-bs-target="#recipeModal{{ r.id }}">
                                    {% if r.image %}
                                        <img src="{{ asset('uploads/recipes/' ~ r.image) }}" class="card-img-top" alt="{{ r.title }}">
                                    {% else %}
                                        <img src="https://via.placeholder.com/400x200?text=Recette" class="card-img-top" alt="{{ r.title }}">
                                    {% endif %}
                                    <div class="card-body">
                                        <h5 class="card-title">{{ r.title }}</h5>
                                    </div>
                                </div>
                            </div>

                            <!-- Modal description recette -->
                            <div class="modal fade" id="recipeModal{{ r.id }}" tabindex="-1" aria-labelledby="recipeModalLabel{{ r.id }}" aria-hidden="true">
                                <div class="modal-dialog modal-lg modal-dialog-centered">
                                    <div class="modal-content">
                                        <div class="modal-header">
                                            <h5 class="modal-title" id="recipeModalLabel{{ r.id }}">{{ r.title }}</h5>
                                            <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
                                        </div>
                                        <div class="modal-body">
                                            {% if r.user %}
                                                <div class="d-flex align-items-center mb-3">
                                                    {% if r.user.avatar %}
                                                        <img src="{{ asset('uploads/avatars/' ~ r.user.avatar) }}" alt="{{ r.user.username }}" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                                                    {% else %}
                                                        <img src="{{ asset('images/default-avatar.png') }}" alt="{{ r.user.username }}" class="rounded-circle me-2" style="width:40px; height:40px; object-fit:cover;">
                                                    {% endif %}
                                                    <a href="{{ path('user_show', {'id': r.user.id}) }}" class="fw-bold text-decoration-none">{{ r.user.username }}</a>
                                                </div>
                                            {% endif %}
                                            {% if r.image %}
                                                <img src="{{ asset('uploads/recipes/' ~ r.image) }}" class="img-fluid mb-3" alt="{{ r.title }}">
                                            {% endif %}
                                            <p><strong>Description:</strong> {{ r.description }}</p>
                                            <p><strong>Ingrédients:</strong></p>
                                            <pre>{{ r.ingredients }}</pre>
                                            <p><strong>Étapes:</strong></p>
                                            <pre>{{ r.steps }}</pre>
                                            <p><strong>Catégorie:</strong> {{ r.category.name }}</p>
                                            <p><strong>Préparation:</strong> {{ r.preparationTime }} min</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                </div>
            {% else %}
                <p class="text-muted">Vous n'avez aucun favori pour le moment.</p>
            {% endif %}
        </div>
    </div>
</div>

<!-- Modale de confirmation suppression -->
<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Supprimer la recette</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>
      <div class="modal-body">
        Voulez-vous vraiment supprimer cette recette ?
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
        <form id="deleteRecipeForm" method="POST" action="">
            <input type="hidden" name="_token" id="deleteCsrfToken" value="">
            <button type="submit" class="btn btn-danger">Supprimer</button>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Empêche le clic sur les boutons de modifier/supprimer d'ouvrir la modal de recette
    document.querySelectorAll('.card .btn').forEach(btn => {
        btn.addEventListener('click', e => e.stopPropagation());
    });

    // Boutons supprimer
    document.querySelectorAll('.delete-btn').forEach(btn => {
        btn.addEventListener('click', function(e){
            e.stopPropagation(); // ne pas ouvrir la modal description
            const recipeId = btn.dataset.recipeId;
            const csrf = btn.dataset.csrf;
            const form = document.getElementById('deleteRecipeForm');
            form.action = '/recipe/' + recipeId; // route delete
            document.getElementById('deleteCsrfToken').value = csrf;

            const modal = new bootstrap.Modal(document.getElementById('confirmDeleteModal'));
            modal.show();
        });
    });
});
</script>
{% endblock %}
